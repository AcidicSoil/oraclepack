# Oraclepack PRD

## Overview

### Problem Statement

Oraclepack is a runner for strict, 20-step Oracle Packs, but its pipeline is brittle and incomplete: pack shape drift causes validation failures, execution context (workdir/state output paths) is inconsistent, and post-run outputs are not reliably structured for automated follow-on work. Action Packs are perceived as "oracle-only," so they do not deterministically dispatch real executors (codex/gemini/tm), and TUI/MCP flows for PRD generation and tool routing are incomplete. The result is high friction, low determinism, and poor automation handoff.

### Target Users

- Workflow engineers generating and running Oracle Packs and Action Packs in CI/headless modes.
- Developers using oraclepack TUI to run multi-step workflows and manage ChatGPT project URLs.
- Maintainers distributing oraclepack and oraclepack-mcp-server to teams.

### Success Metrics

- TODO: Define baseline failure rate for `oraclepack validate` and reduce invalid-pack runs by X%.
- TODO: Ensure 0 new `*.state.json` / `*.report.json` / `*.chatgpt-urls.json` are created in repo roots by default.
- TODO: Action Pack runs produce expected artifacts under `.oraclepack/ticketify/` in >= 95% of runs when tools are available.
- TODO: MCP run parity: 100% of CLI run flags relevant to execution context are available via MCP tools.

## Capability Tree (Functional Decomposition)

### Capability: Pack Authoring and Validation

Ensure packs are always runner-ingestible and structurally safe.

#### Feature: Strict pack-shape validation

- **Description**: Enforce the single-bash-fence + 20-step invariant on pack validation.
- **Inputs**: Pack Markdown path.
- **Outputs**: Validation pass/fail + errors.
- **Behavior**: Count fences, require exactly one ```bash fence, require 20 sequential `# NN)` steps; reject other fences.
- **MVP**: Yes.

#### Feature: Schema-first manifest + deterministic renderer

- **Description**: Validate a manifest JSON schema and render a compliant pack.
- **Inputs**: Manifest JSON (schema_version, kind, out_dir, steps[20]).
- **Outputs**: Rendered pack Markdown + schema validation report.
- **Behavior**: Enforce 20 steps with IDs 01..20, render one bash fence with out_dir prelude and step bodies.
- **MVP**: No.

#### Feature: Bash safety lint for orphaned flags

- **Description**: Prevent `-p/--prompt` lines from becoming standalone commands.
- **Inputs**: Extracted bash fence text.
- **Outputs**: Validation pass/fail + lint diagnostics.
- **Behavior**: Run `bash -n` and a custom detector for orphaned flags; optional shellcheck integration.
- **MVP**: Yes.

#### Feature: Attachment preflight

- **Description**: Verify `-f` attachment paths exist before execution.
- **Inputs**: Pack steps + workdir.
- **Outputs**: Preflight report with missing files list.
- **Behavior**: Extract invocations, ensure referenced files exist under resolved workdir; fail or warn per mode.
- **MVP**: Yes.

### Capability: Execution and State Management

Make execution deterministic, resumable, and non-invasive to repo roots.

#### Feature: Deterministic workdir resolution

- **Description**: Resolve workdir to repo root when `--work-dir` is absent.
- **Inputs**: packPath, optional work_dir flag.
- **Outputs**: Resolved WorkDir.
- **Behavior**: Infer repo root from packPath; use it as WorkDir unless overridden.
- **MVP**: Yes.

#### Feature: Externalized state/report storage

- **Description**: Store run state/report and URL data outside the repo root by default.
- **Inputs**: pack base name, env/flag overrides.
- **Outputs**: Paths for state/report/config stores.
- **Behavior**: Use XDG config/state/cache defaults; allow `--state-dir` or `ORACLEPACK_STATE_DIR` override.
- **MVP**: Yes.

#### Feature: Run manifest and step index

- **Description**: Emit deterministic run metadata for automation.
- **Inputs**: Pack, run context, step execution results.
- **Outputs**: `run.json`, `steps.json`, report state.
- **Behavior**: Persist pack hash, git SHA, step statuses, output paths; idempotent resume based on outputs.
- **MVP**: No.

#### Feature: Resume/rerun semantics

- **Description**: Resume from failed/interrupted steps and support rerun modes.
- **Inputs**: run state + outputs + rerun policy.
- **Outputs**: Updated state/report.
- **Behavior**: Skip succeeded steps by default; support `--rerun all|failed|01,03`.
- **MVP**: No.

### Capability: Action Pack Workflow and Tool Dispatch

Enable action execution beyond oracle-only flows.

#### Feature: Canonical action artifacts

- **Description**: Standardize `_tickets_index.json`, `_actions.json`, `_actions.md`, and PRD artifacts.
- **Inputs**: Ticket data, oracle outputs, Task Master outputs.
- **Outputs**: `.oraclepack/ticketify/_tickets_index.json`, `_actions.json`, `_actions.md`, `.taskmaster/docs/tickets_prd.md`.
- **Behavior**: Deterministic paths; stable schemas for machine processing.
- **MVP**: Yes.

#### Feature: Action Pack implement dispatcher

- **Description**: Dispatch executor commands (codex/gemini/tm) based on `_actions.json`.
- **Inputs**: `_actions.json`, tooling config, top_n.
- **Outputs**: `.oraclepack/ticketify/next.json`, `codex-implement.md`, `codex-verify.md` and/or `gemini-review.json`, `PR.md`.
- **Behavior**: Replace placeholder steps 09-13 and 16 with headless non-interactive commands; guard missing binaries with skip semantics.
- **MVP**: Yes (guarded, opt-in).

#### Feature: Tool-agnostic overrides/validation (dispatcher v2)

- **Description**: Expand command detection and validation beyond `oracle`.
- **Inputs**: Step scripts + registry of tool prefixes.
- **Outputs**: Validation results + targeted overrides.
- **Behavior**: Detect tm/task-master, codex, gemini; preserve existing oracle-only behavior unless opt-in flag is set.
- **MVP**: No (opt-in rollout).

#### Feature: Taskify agent-mode generation

- **Description**: Add `agent-mode` to taskify-generated packs without changing 20-step contract.
- **Inputs**: taskify params, mode=codex|gemini.
- **Outputs**: Modified Action Pack with swapped step slot after Task Master expansion.
- **Behavior**: Swap existing autopilot step slot, keep total steps at 20.
- **MVP**: No.

### Capability: TUI and PRD Routing

Improve TUI URL selection and PRD generation flow.

#### Feature: PRD Generator URL selection

- **Description**: Add `PRD Generator` URL entry in picker with defaulting.
- **Inputs**: URL picker storage, project/global scope.
- **Outputs**: Selected ChatGPT URL for run overrides.
- **Behavior**: Allow project/global scope, default selection, no URL hardcoding in packs.
- **MVP**: Yes.

#### Feature: Headless chatgpt-url CLI override

- **Description**: Enable `--chatgpt-url` or `--chatgpt-url-name` for headless runs.
- **Inputs**: CLI flags.
- **Outputs**: Applied ChatGPT URL override.
- **Behavior**: Apply URL override without TUI.
- **MVP**: Yes.

#### Feature: PRD micro-pack / call mode

- **Description**: Run PRD generation without treating `tickets_prd.md` as a pack.
- **Inputs**: `tickets_prd.md`, optional `prd_context.md`.
- **Outputs**: `final_prd.md` in Task Master docs.
- **Behavior**: Generate a valid micro-pack or `oraclepack call` path with a single oracle invocation and attachments.
- **MVP**: Yes.

### Capability: MCP Server Parity and Distribution

Ensure MCP tools match CLI capabilities and are easy to install.

#### Feature: MCP run flag passthrough

- **Description**: Expose `work_dir`, `oracle_bin`, `out_dir` via MCP run tool.
- **Inputs**: MCP tool parameters.
- **Outputs**: CLI invocation with flags applied.
- **Behavior**: Append flags to CLI command for `oraclepack_run_pack`.
- **MVP**: Yes.

#### Feature: Pack generation tools via MCP/CLI

- **Description**: Provide `oraclepack generate` and MCP tools for grouped packs.
- **Inputs**: tickets/codebase paths.
- **Outputs**: `out_dir/packs/*.md`, `_groups.json`.
- **Behavior**: Deterministic discovery + grouping + validation after generation.
- **MVP**: No.

#### Feature: Simplified MCP distribution

- **Description**: Publish `oraclepack-mcp-server` for short configs.
- **Inputs**: PyPI/uv tooling, MCP bundle metadata.
- **Outputs**: PATH executable, uvx config example, optional `.mcpb` bundle.
- **Behavior**: Provide short config without venv absolute path.
- **MVP**: No.

### Capability: Pipeline Actionizer (Stage 3)

Create a deterministic stage that converts outputs into actionable work.

#### Feature: Actionizer command

- **Description**: Convert 20 oracle outputs into normalized backlog artifacts.
- **Inputs**: run dir outputs, run metadata.
- **Outputs**: `normalized.jsonl`, `backlog.md`, `change-plan.md`, optional `taskmaster.json`.
- **Behavior**: Deduplicate, categorize, assign stable IDs; idempotent regeneration.
- **MVP**: No.

## Repository Structure + Module Definitions (Structural Decomposition)

### Module: `internal/pack`

- **Maps to capability**: Pack Authoring and Validation
- **Responsibility**: Parse/validate pack structure and provide pack data model.
- **File structure**:

  ```
  internal/pack/
  |-- parser.go
  |-- types.go
  `-- output_check.go
  ```

- **Exports**:
  - `ParsePack(path string) (*Pack, error)` - parse the first bash fence into steps.
  - `ValidatePack(pack *Pack) error` - enforce single-fence + 20-step constraints.
  - `ValidateStrict(pack *Pack) error` - optional strict validators (orphaned flags, ROI, etc).

### Module: `internal/exec`

- **Maps to capability**: Execution and Tool Dispatch
- **Responsibility**: Extract/validate invocations and run steps safely.
- **File structure**:

  ```
  internal/exec/
  |-- oracle_scan.go
  |-- oracle_validate.go
  |-- runner.go
  `-- sanitize.go
  ```

- **Exports**:
  - `ExtractInvocations(step Step) ([]Invocation, error)`
  - `InjectOverrides(step Step, overrides Overrides) (Step, error)`
  - `PreflightAttachments(invocations []Invocation, workdir string) error`
  - `RunStep(ctx RunContext, step Step) StepResult`

### Module: `internal/state`

- **Maps to capability**: Execution and State Management
- **Responsibility**: Resolve state/report paths, persist run state.
- **File structure**:

  ```
  internal/state/
  |-- persist.go
  `-- types.go
  ```

- **Exports**:
  - `ResolveStateDir() (string, error)`
  - `ResolveConfigDir() (string, error)`
  - `LoadState(path string) (*RunState, error)`
  - `SaveState(path string, state *RunState) error`

### Module: `internal/report`

- **Maps to capability**: Execution and Actionizer Metadata
- **Responsibility**: Build deterministic run manifests and reports.
- **File structure**:

  ```
  internal/report/
  |-- generate.go
  `-- types.go
  ```

- **Exports**:
  - `GenerateReport(run RunContext, results []StepResult) (*Report, error)`
  - `WriteRunManifest(path string, manifest RunManifest) error`

### Module: `internal/cli`

- **Maps to capability**: CLI Feature Surface
- **Responsibility**: CLI commands, flags, and config wiring.
- **File structure**:

  ```
  internal/cli/
  |-- root.go
  |-- cmds.go
  `-- run.go
  ```

- **Exports**:
  - `NewRootCmd() *cobra.Command`
  - `RegisterRunFlags(cmd *cobra.Command)`

### Module: `internal/app`

- **Maps to capability**: Execution Orchestration
- **Responsibility**: Orchestrate validate -> preflight -> run -> report.
- **File structure**:

  ```
  internal/app/
  |-- app.go
  `-- run.go
  ```

- **Exports**:
  - `RunPack(ctx AppContext, packPath string) error`

### Module: `internal/tui`

- **Maps to capability**: TUI and PRD Routing
- **Responsibility**: URL picker/store, overrides wizard, PRD flow UI.
- **File structure**:

  ```
  internal/tui/
  |-- tui.go
  |-- url_picker.go
  `-- overrides_*.go
  ```

- **Exports**:
  - `RunTUI(ctx TUIContext) error`
  - `PickChatGPTURL(store URLStore) (URLSelection, error)`

### Module: `oraclepack-mcp-server/oraclepack_mcp_server`

- **Maps to capability**: MCP Server Parity and Distribution
- **Responsibility**: MCP tools for running packs and taskify flows.
- **File structure**:

  ```
  oraclepack-mcp-server/oraclepack_mcp_server/
  |-- server.py
  |-- oraclepack_cli.py
  `-- taskify.py
  ```

- **Exports**:
  - `oraclepack_run_pack(...)` MCP tool
  - `oraclepack_generate_*` MCP tools (future)

## Dependency Chain (Structural Layers)

### Layer 0 (Foundations)

- `internal/errors`
- `internal/pack` (types + parser)

### Layer 1 (State + Validation)

- `internal/state` (XDG resolution)
- `internal/pack` (strict validation)
- `internal/overrides` (types)

### Layer 2 (Execution Primitives)

- `internal/exec` (invocation scan, preflight, runner)
- `internal/report` (run/step manifests)
- `internal/render` (manifest -> pack)

### Layer 3 (Orchestration)

- `internal/app` (validate -> preflight -> run -> report)

### Layer 4 (Interfaces)

- `internal/cli`
- `internal/tui`

### Layer 5 (External Integration)

- `oraclepack-mcp-server/oraclepack_mcp_server`

## Development Phases

### Phase 0: Validation and Deterministic Execution Foundations

- **Tasks**:
  - Enforce strict pack-shape validation (single bash fence, 20 steps).
  - Add bash safety lint for orphaned flags.
  - Add workdir resolution and `--work-dir` flag.
  - Add XDG-based state/config/cache resolution and `--state-dir` override.
- **Dependencies**: Layer 0 -> Layer 2.
- **Acceptance Criteria**:
  - `oraclepack validate` rejects extra fences and wrong step counts.
  - Pack with orphaned `-p` lines fails validation.
  - `oraclepack run` defaults to repo-root workdir; `--work-dir` overrides it.
  - State/report outputs no longer appear in repo root by default.
- **Test Strategy**:
  - Unit tests for `ValidatePack` and orphaned-flag detection.
  - Integration test validating a fixture pack with invalid fences/steps.

### Phase 1: Preflight, Reporting, and Resume

- **Tasks**:
  - Add attachment preflight for `-f` paths.
  - Emit `run.json` and `steps.json` with stable schema.
  - Implement resume/rerun semantics.
- **Dependencies**: Phase 0 complete.
- **Acceptance Criteria**:
  - Missing attachments produce actionable preflight errors.
  - Each run writes run/step manifests with deterministic paths.
  - Resume skips previously successful steps by default.
- **Test Strategy**:
  - Integration test: partial run -> resume -> correct step continuation.

### Phase 2: Action Pack Automation + Dispatcher

- **Tasks**:
  - Standardize `_actions.json` schema with `executor`, `exec_prompt`, `inputs`.
  - Replace placeholder steps in `ticket-action-pack.md` with headless codex/gemini guarded commands (opt-in).
  - Add agent-mode option for taskify packs (swap step slot).
  - Add tool-availability guards and skip semantics.
- **Dependencies**: Phase 1 (stable execution + state).
- **Acceptance Criteria**:
  - Action Pack runs produce expected artifacts under `.oraclepack/ticketify/` when tools exist.
  - Missing codex/gemini results in "skipped" outputs, not hard failures.
  - Agent-mode preserves 20-step contract.
- **Test Strategy**:
  - Fixture pack with mocked tools to verify skip behavior and artifact creation.

### Phase 3: TUI + MCP Surface + Distribution

- **Tasks**:
  - Add PRD Generator URL entry and selection flows.
  - Add `--chatgpt-url` / `--chatgpt-url-name` CLI overrides.
  - Add micro-pack or `oraclepack call` path for PRD generation.
  - Extend MCP `oraclepack_run_pack` with `work_dir`, `oracle_bin`, `out_dir`.
  - Document short config and publish MCP server distribution.
- **Dependencies**: Phase 0 for core execution; Phase 2 optional for PRD integration.
- **Acceptance Criteria**:
  - TUI supports selecting PRD Generator URL and running PRD flow without invalid-pack errors.
  - MCP tools run with explicit workdir/oracle_bin/out_dir.
  - Documentation includes short MCP config examples.
- **Test Strategy**:
  - TUI unit tests for URL picker defaults.
  - MCP integration test invoking run with explicit flags.

## User Experience

### Personas

- **Workflow Engineer**: Builds packs and runs them in CI/headless mode; needs deterministic outputs and resume.
- **TUI Operator**: Runs packs interactively and manages ChatGPT project URLs.
- **Integrator**: Uses MCP server and expects concise configuration and parity with CLI.

### Key Flows

- **Run a pack (CLI)**: validate -> preflight -> run -> report; state stored outside repo.
- **Run Action Pack (CLI/TUI)**: steps 01-07 generate Task Master artifacts; optional implement mode dispatches codex/gemini; outputs appear under `.oraclepack/ticketify/`.
- **PRD generation (TUI/Headless)**: select PRD Generator URL -> run micro-pack with `tickets_prd.md` + `prd_context.md` -> write `final_prd.md`.
- **MCP run**: use `oraclepack_run_pack` with explicit `work_dir` and `oracle_bin` to avoid PATH issues.

### UI/UX Notes

- Clearly label oracle-only override validation vs non-oracle steps.
- Show "skipped due to missing tool" vs "skipped by ROI filter."
- Provide a dedicated TUI option for PRD generation that avoids running `tickets_prd.md` as a pack.

## Technical Architecture

### Components

- **Pack Parser/Validator**: Enforces single-fence and 20-step schema; strict lint for bash safety.
- **Execution Engine**: Runs steps via `bash -lc`, performs preflight checks, injects overrides, writes state/report.
- **State/Report Store**: XDG-based location, run.json + steps.json.
- **Action Pack Dispatcher**: Reads `_actions.json`, selects executor, runs headless tool commands, writes deterministic artifacts.
- **TUI URL Store**: Global/project scoped URL persistence; CLI override support.
- **MCP Server**: Wraps CLI and exposes run/generate tools with parity flags.

### Data Models

- **Pack**: `Pack{Steps[20], Prelude}` with single bash fence.
- **Run Manifest**: `run.json` (pack hash, git SHA, versions, timestamps).
- **Step Manifest**: `steps.json` (step_id, command_hash, output_path, status).
- **Action Artifacts**: `_tickets_index.json`, `_actions.json`, `_actions.md`, `next.json`, `codex-implement.md`, `codex-verify.md`, `gemini-review.json`, `PR.md`.
- **URL Store**: global/project JSON config for ChatGPT URLs.

### APIs / Integrations

- **Oracle CLI**: validation (`--dry-run summary`) and execution.
- **Task Master CLI**: parse PRD, analyze complexity, expand tasks.
- **Codex CLI / Gemini CLI**: non-interactive executor steps for implementation/verification.
- **MCP**: `oraclepack_run_pack`, future `oraclepack_generate_*` tools.

### Decisions and Trade-offs

- Preserve pack schema (single bash fence, 20 steps) and enforce with validators; do not relax.
- Opt-in dispatcher expansion for non-oracle tools to preserve backward compatibility.
- Use deterministic paths under `.oraclepack/` for action artifacts; use XDG for run state defaults.

## Test Strategy

- **Unit tests**: parser/validator fence counting; orphaned-flag detector; XDG path resolution.
- **Integration tests**: run -> resume flow; missing attachment preflight; ROI filtering skip reporting.
- **Fixture packs**: valid/invalid packs with multiple fences, bad numbering, missing ROI.
- **Tool-availability tests**: simulate missing codex/gemini with command guards and verify skip semantics.
- **MCP tests**: run tool with explicit `work_dir` and `oracle_bin` flags.

## Risks and Mitigations

- **Tool availability and interactivity**: codex/gemini/tm may not be installed or may block; mitigate with `command -v` guards, headless flags, and skip reporting.
- **Backward compatibility**: expanding dispatch/validation beyond oracle risks behavior changes; mitigate with feature flags and opt-in modes.
- **Schema drift**: generator or templates may emit invalid packs; mitigate with strict validation and fixture tests.
- **State path changes**: moving state/report outputs may confuse users; mitigate with migration notes and override flags.
- **ROI filtering skips required steps**: mitigate by enforcing ROI metadata for critical steps and warning when filters are active.
- **Unspecified override semantics for non-oracle tools**: keep oracle-only behavior as default and document gaps.

## Appendix

### Sources Consulted

- `.tickets/*` (actions, mcp, PRD-TUI, misc, other)
- `docs/oracle-questions-2026-01-08/actions/*.md`
- `README.md`

### Open Questions

- TODO: Define success metric baselines and thresholds (validation pass rate, run failure rate).
- TODO: Confirm desired override semantics for non-oracle tools (which flags, how to validate).
- TODO: Confirm canonical schemas for `_tickets_index.json`, `_actions.json`, and `run.json`.
- TODO: Confirm whether manifest-first pack generation is required in MVP.

## Task-Master Integration Notes (Optional)

- Capability Tree items map to Task Master tasks; Features map to subtasks.
- Dependencies map to task dependencies; phases map to priorities.
- Action Pack artifacts (`_actions.json`) should align with Task Master task schemas for downstream automation.
